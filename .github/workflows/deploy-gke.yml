name: Deploy to GKE

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_ID: dev-ops-475910
  GKE_CLUSTER: nadun-task-app-cluster
  GKE_ZONE: us-central1-a
  BACKEND_IMAGE: nadun-task-backend
  FRONTEND_IMAGE: nadun-task-frontend
  USE_GKE_GCLOUD_AUTH_PLUGIN: True

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Install gke-gcloud-auth-plugin
        run: |
          echo "Installing gke-gcloud-auth-plugin..."
          gcloud components install gke-gcloud-auth-plugin --quiet
          echo "Installed version:"
          gke-gcloud-auth-plugin --version

      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker

      - name: Get GKE Credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --zone ${{ env.GKE_ZONE }} \
            --project ${{ env.PROJECT_ID }}

      - name: Verify kubectl connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Build Backend Image
        run: |
          cd todo-api
          docker build -t gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }} .
          docker tag gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }} \
            gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:latest

      - name: Build Frontend Image
        run: |
          cd todo-frontend
          docker build \
            --build-arg REACT_APP_API_URL=http://34.55.79.94:8080 \
            -t gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }} .
          docker tag gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }} \
            gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:latest

      - name: Publish Images to GCR
        run: |
          docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:latest
          docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:latest

      - name: Update Kubernetes Manifests
        run: |
          sed -i "s|:latest|:${{ github.sha }}|g" k8s/backend-deployment.yaml
          sed -i "s|:latest|:${{ github.sha }}|g" k8s/frontend-deployment.yaml

      - name: Deploy to GKE
        run: |
          # Apply namespace
          kubectl apply -f k8s/namespace.yaml
          
          # Apply secrets
          kubectl apply -f k8s/secret-serviceaccount.yaml
          kubectl apply -f k8s/secret-store.yaml
          kubectl apply -f k8s/external-secrets.yaml
          
          # Apply PVC
          kubectl apply -f k8s/postgres-pvc.yaml
          
          # Deploy PostgreSQL
          kubectl apply -f k8s/postgres-deployment.yaml
          
          # Deploy Backend
          kubectl apply -f k8s/backend-deployment.yaml

          # --- ADD THIS LINE ---
          kubectl apply -f k8s/backend-servicemonitor.yaml

          # Wait for Backend
          echo "Waiting for Backend to be ready..."
          
          # Wait for PostgreSQL
          echo "Waiting for PostgreSQL to be ready..."
          kubectl wait --for=condition=ready pod -l app=postgres -n nadun-task-app --timeout=300s || true
          sleep 30
          
          # Deploy Backend
          kubectl apply -f k8s/backend-deployment.yaml
          
          # Wait for Backend
          echo "Waiting for Backend to be ready..."
          kubectl wait --for=condition=ready pod -l app=backend -n nadun-task-app --timeout=300s || true
          sleep 30
          
          # Deploy Frontend
          kubectl apply -f k8s/frontend-deployment.yaml
          
          # Wait for Frontend
          echo "Waiting for Frontend to be ready..."
          kubectl wait --for=condition=ready pod -l app=frontend -n nadun-task-app --timeout=300s || true

      - name: Get Service Information
        run: |
          echo "=========================================="
          echo "Deployment Complete!"
          echo "=========================================="
          echo ""
          echo "Namespace resources:"
          kubectl get all -n nadun-task-app
          echo ""
          echo "Services:"
          kubectl get services -n nadun-task-app
          echo ""
          echo "Pods:"
          kubectl get pods -n nadun-task-app -o wide
          echo ""
          echo "=========================================="
          echo "External IPs may take 5-10 minutes to be assigned."
          echo ""
          echo "To get Backend IP, run:"
          echo "kubectl get service backend -n nadun-task-app -o jsonpath='{.status.loadBalancer.ingress[0].ip}'"
          echo ""
          echo "To get Frontend IP, run:"
          echo "kubectl get service frontend -n nadun-task-app -o jsonpath='{.status.loadBalancer.ingress[0].ip}'"
          echo "=========================================="

      - name: Verify Deployment
        run: |
          echo "Checking rollout status..."
          kubectl rollout status deployment/postgres -n nadun-task-app --timeout=5m
          kubectl rollout status deployment/backend -n nadun-task-app --timeout=5m
          kubectl rollout status deployment/frontend -n nadun-task-app --timeout=5m
          echo ""
          echo "âœ… All deployments are ready!"